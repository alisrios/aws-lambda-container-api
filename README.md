# üß™ AWS Lambda Container API - Teste T√©cnico

[![CI/CD Pipeline](https://github.com/your-username/aws-lambda-container-api/actions/workflows/ci-cd.yml/badge.svg)](https://github.com/your-username/aws-lambda-container-api/actions)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Python 3.11](https://img.shields.io/badge/python-3.11-blue.svg)](https://www.python.org/downloads/release/python-3110/)
[![Docker](https://img.shields.io/badge/docker-%230db7ed.svg?style=flat&logo=docker&logoColor=white)](https://www.docker.com/)
[![AWS Lambda](https://img.shields.io/badge/AWS-%23FF9900.svg?style=flat&logo=amazon-aws&logoColor=white)](https://aws.amazon.com/lambda/)
[![Terraform](https://img.shields.io/badge/terraform-%235835CC.svg?style=flat&logo=terraform&logoColor=white)](https://www.terraform.io/)

## üìã Sobre o Projeto

Este projeto foi desenvolvido como resposta ao **Teste T√©cnico ‚Äì Deploy de API com AWS e Terraform**. 

Implementa uma API Python simples usando Flask, empacotada em container Docker, publicada no Amazon ECR, e deployada como fun√ß√£o Lambda integrada com API Gateway HTTP. Todo o processo √© automatizado atrav√©s de pipeline CI/CD usando GitHub Actions com backend remoto S3 para o estado do Terraform.

### üéØ Requisitos Atendidos

- ‚úÖ **API funcional em Python** com Flask
- ‚úÖ **Rotas `/hello` e `/echo`** conforme especificado
- ‚úÖ **Container Docker** publicado no Amazon ECR
- ‚úÖ **Infraestrutura Terraform** com Lambda e API Gateway
- ‚úÖ **Backend remoto S3** para estado do Terraform
- ‚úÖ **Outputs** da URL da API e nome da fun√ß√£o
- ‚úÖ **CI/CD automatizado** com GitHub Actions

## üöÄ Como Rodar Localmente

### Pr√©-requisitos

- Python 3.11+
- Docker e Docker Compose
- AWS CLI configurado
- Terraform 1.5.0+

### 1. Configurar Ambiente

```bash
# Clonar reposit√≥rio
git clone https://github.com/your-username/aws-lambda-container-api.git
cd aws-lambda-container-api

# Executar script de setup
./setup.sh
```

### 2. Executar Aplica√ß√£o Local

```bash
# Ativar ambiente virtual
source venv/bin/activate

# Executar Flask localmente
python run_local.py
```

### 3. Testar Localmente

```bash
# Testar endpoint /hello
curl http://localhost:5000/hello

# Testar endpoint /echo
curl "http://localhost:5000/echo?msg=Hello%20World"

# Testar health check
curl http://localhost:5000/health
```

### 4. Testar com Docker

```bash
# Usar Docker Compose
docker-compose up -d

# Acessar interface de teste
open http://localhost:8000/test.html

# Parar servi√ßos
docker-compose down
```

## ‚òÅÔ∏è Como Subir a Infraestrutura

### 1. Configurar Backend S3 (Obrigat√≥rio)

```bash
# Executar script de configura√ß√£o do backend
./scripts/setup-terraform-backend.sh
```

Este script ir√°:
- Criar bucket S3 para estado do Terraform
- Criar tabela DynamoDB para lock de estado
- Configurar criptografia e versionamento
- Atualizar configura√ß√£o do backend

### 2. Deploy da Infraestrutura

```bash
# Navegar para diret√≥rio terraform
cd terraform

# Inicializar Terraform (j√° feito pelo script anterior)
terraform init

# Planejar deployment
terraform plan

# Aplicar mudan√ßas
terraform apply
```

### 3. Build e Push da Imagem Docker

```bash
# Voltar ao diret√≥rio raiz
cd ..

# Build e push da imagem para ECR
./build-and-push.sh
```

### 4. Verificar Deployment

```bash
# Obter URL da API dos outputs do Terraform
cd terraform
terraform output api_gateway_url

# Testar API deployada
curl $(terraform output -raw api_gateway_url)/hello
curl "$(terraform output -raw api_gateway_url)/echo?msg=teste"
```

## üß™ Como Testar a API

### Endpoints Dispon√≠veis

#### `GET /hello`
Retorna uma mensagem "Hello World" simples.

```bash
curl https://YOUR-API-ID.execute-api.us-east-1.amazonaws.com/hello
```

**Resposta:**
```json
{
  "message": "Hello World",
  "timestamp": "2025-08-07T16:34:35.830082Z",
  "version": "1.0.0"
}
```

#### `GET /echo?msg=<mensagem>`
Retorna a mensagem fornecida no par√¢metro `msg`.

```bash
curl "https://YOUR-API-ID.execute-api.us-east-1.amazonaws.com/echo?msg=teste"
```

**Resposta:**
```json
{
  "message": "teste",
  "echo": true,
  "timestamp": "2025-08-07T16:34:40.176437Z"
}
```

**Erro sem par√¢metro:**
```bash
curl https://YOUR-API-ID.execute-api.us-east-1.amazonaws.com/echo
```

```json
{
  "error": "Parameter 'msg' is required",
  "status_code": 400,
  "timestamp": "2025-08-07T16:34:49.383925Z"
}
```

#### `GET /health`
Health check para monitoramento.

```bash
curl https://YOUR-API-ID.execute-api.us-east-1.amazonaws.com/health
```

**Resposta:**
```json
{
  "status": "healthy",
  "timestamp": "2025-08-07T16:34:44.707760Z",
  "version": "1.0.0",
  "environment": "dev"
}
```

### Scripts de Teste

```bash
# Testar todos os endpoints
./scripts/test-api.sh

# Testar com diferentes cen√°rios
python test_api_gateway.py
```

## üîÑ CI/CD Pipeline

### Como Funciona

O projeto inclui um pipeline completo de CI/CD com **GitHub Actions** que utiliza **OpenID Connect (OIDC)** para autentica√ß√£o segura com AWS, eliminando a necessidade de chaves de acesso de longo prazo.

### üîê Autentica√ß√£o OIDC

#### Benef√≠cios da Autentica√ß√£o OIDC:
- ‚úÖ **Seguran√ßa Aprimorada**: Sem credenciais de longo prazo armazenadas
- ‚úÖ **Tokens Tempor√°rios**: Credenciais com tempo de vida limitado
- ‚úÖ **Auditoria Melhorada**: Rastreamento detalhado de acesso
- ‚úÖ **Rota√ß√£o Autom√°tica**: N√£o requer rota√ß√£o manual de chaves

#### Configura√ß√£o OIDC:
```bash
# Executar script de configura√ß√£o autom√°tica
cd terraform
../scripts/setup-github-oidc.sh
```

### Pipeline Execution

O pipeline √© executado automaticamente em:
- **Push** para branches `main` e `develop`
- **Pull Requests** para `main` e `develop`

### Stages do Pipeline

1. **üß™ Test and Quality Checks**
   - Lint do c√≥digo Python (flake8, black)
   - Testes unit√°rios (pytest)
   - Coverage report
   - Security scan (bandit)

2. **üê≥ Build and Push Docker**
   - Build da imagem Docker
   - Scan de vulnerabilidades (Trivy)
   - Push para Amazon ECR
   - Tag com commit hash

3. **üèóÔ∏è Infrastructure Deploy**
   - Terraform validate
   - Terraform plan
   - Terraform apply (auto-approve em main)
   - Update Lambda function code

4. **‚úÖ Integration Tests**
   - Testes end-to-end na API deployada
   - Health checks
   - Performance tests

### Configura√ß√£o do CI/CD

#### Configura√ß√£o OIDC (Recomendado)

1. **Configurar Infraestrutura OIDC**:
```bash
cd terraform
../scripts/setup-github-oidc.sh
```

2. **Configurar Repository Variables no GitHub**:
   - Acesse: `Settings > Secrets and variables > Actions > Variables`
   - Adicione as seguintes **Repository Variables**:
```
AWS_ROLE_TO_ASSUME = arn:aws:iam::ACCOUNT_ID:role/lambda-container-api-dev-github-actions-role
TERRAFORM_STATE_BUCKET = your-terraform-state-bucket-name
```

#### Configura√ß√£o Alternativa (Access Keys)

Se preferir usar chaves de acesso tradicionais, configure os seguintes **Secrets**:

```
AWS_ACCESS_KEY_ID=your-access-key
AWS_SECRET_ACCESS_KEY=your-secret-key
AWS_REGION=us-east-1
```

‚ö†Ô∏è **Nota**: OIDC √© mais seguro e √© a abordagem recomendada.

#### Arquivo de Pipeline

O pipeline est√° definido em `.github/workflows/ci-cd.yml` e inclui:

- **Triggers**: Push e PR para main/develop
- **Matrix Strategy**: Testes em m√∫ltiplas vers√µes Python
- **Caching**: Dependencies e Docker layers
- **Artifacts**: Reports de teste e coverage
- **Notifications**: Status do deploy

### Monitoramento

- **CloudWatch Dashboard**: M√©tricas em tempo real
- **Alertas**: SNS notifications para erros
- **Logs**: Structured logging em JSON
- **Tracing**: X-Ray para debugging

## üèóÔ∏è Arquitetura da Solu√ß√£o

```mermaid
graph TB
    A[GitHub Repository] --> B[GitHub Actions CI/CD]
    B --> C[Docker Build & Push to ECR]
    C --> D[Terraform Deploy]
    D --> E[AWS Lambda Function]
    E --> F[API Gateway HTTP API]
    F --> G[Public HTTPS Endpoint]
    
    H[S3 Backend] --> D
    I[DynamoDB Lock] --> D
    J[CloudWatch Logs] --> E
    K[CloudWatch Metrics] --> E
    L[X-Ray Tracing] --> E
    
    style A fill:#f9f,stroke:#333,stroke-width:2px
    style E fill:#ff9,stroke:#333,stroke-width:2px
    style F fill:#9ff,stroke:#333,stroke-width:2px
    style H fill:#ffa,stroke:#333,stroke-width:2px
```

### Componentes AWS

- **Lambda Function**: Container executando Flask API
- **API Gateway**: HTTP API com integra√ß√£o Lambda
- **ECR Repository**: Armazenamento de imagens Docker
- **CloudWatch**: Logs, m√©tricas e alertas
- **S3**: Backend remoto para estado Terraform
- **DynamoDB**: Lock de estado Terraform
- **IAM**: Roles e pol√≠ticas de seguran√ßa

## üìä Outputs do Terraform

```bash
# Obter todos os outputs
terraform output

# Outputs principais:
api_gateway_url = "https://4zohzp4tpl.execute-api.us-east-1.amazonaws.com"
lambda_function_name = "lambda-container-api-dev"
ecr_repository_url = "148761658767.dkr.ecr.us-east-1.amazonaws.com/lambda-container-api-dev"
```

## üßπ Limpeza de Recursos

‚ö†Ô∏è **IMPORTANTE**: Para evitar custos, sempre execute o destroy ap√≥s os testes:

### Op√ß√£o 1: Script Automatizado (Recomendado)

```bash
# Usar script que for√ßa exclus√£o do ECR com imagens
cd terraform
../scripts/force-destroy.sh
```

Este script ir√°:
- Verificar imagens existentes no ECR
- Executar `terraform destroy` com confirma√ß√£o
- For√ßar exclus√£o do reposit√≥rio ECR mesmo com imagens
- Fazer limpeza adicional se necess√°rio

### Op√ß√£o 2: Terraform Destroy Manual

```bash
# Destruir infraestrutura manualmente
cd terraform
terraform destroy
```

**Nota**: Com a configura√ß√£o `force_delete = true` no ECR, o reposit√≥rio ser√° exclu√≠do automaticamente mesmo contendo imagens.

### Limpeza Adicional (Opcional)

```bash
# Limpar backend S3 (cuidado com outros projetos)
# aws s3 rb s3://terraform-state-lambda-container-api-TIMESTAMP --force
# aws dynamodb delete-table --table-name terraform-state-lock
```

## üìà M√©tricas de Performance

- **Cold Start**: ~2.3 segundos (primeira execu√ß√£o)
- **Warm Executions**: ~1.5-3.6ms (execu√ß√µes subsequentes)
- **Memory Usage**: ~62MB (de 512MB alocados)
- **Image Size**: ~1.04GB (otimizada para Lambda)
- **Test Coverage**: >85%

## üõ†Ô∏è Estrutura do Projeto

```
aws-lambda-container-api/
‚îú‚îÄ‚îÄ .github/workflows/ci-cd.yml    # Pipeline CI/CD
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app.py                     # Flask API
‚îÇ   ‚îú‚îÄ‚îÄ lambda_function.py         # Lambda handler
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt           # Dependencies
‚îú‚îÄ‚îÄ terraform/
‚îÇ   ‚îú‚îÄ‚îÄ main.tf                    # Infrastructure
‚îÇ   ‚îú‚îÄ‚îÄ backend.tf                 # S3 backend config
‚îÇ   ‚îú‚îÄ‚îÄ variables.tf               # Variables
‚îÇ   ‚îî‚îÄ‚îÄ outputs.tf                 # Outputs
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ setup-terraform-backend.sh # Backend setup
‚îÇ   ‚îî‚îÄ‚îÄ test-api.sh                # API testing
‚îú‚îÄ‚îÄ Dockerfile                     # Container config
‚îú‚îÄ‚îÄ docker-compose.yml             # Local development
‚îú‚îÄ‚îÄ build-and-push.sh             # Build script
‚îî‚îÄ‚îÄ README.md                     # This file
```

## üîß Troubleshooting

### Problemas Comuns

#### 1. Erro no Backend S3
```bash
# Reconfigurar backend
./scripts/setup-terraform-backend.sh
cd terraform
terraform init -reconfigure
```

#### 2. Erro no Build Docker
```bash
# Limpar cache Docker
docker system prune -a
./build-and-push.sh --no-cache
```

#### 3. Lambda n√£o atualiza
```bash
# For√ßar update da fun√ß√£o
aws lambda update-function-code \
  --function-name lambda-container-api-dev \
  --image-uri $(terraform output -raw ecr_repository_url):latest
```

#### 4. API Gateway 500 Error
```bash
# Verificar logs CloudWatch
aws logs tail /aws/lambda/lambda-container-api-dev --follow
```

### Logs e Debugging

```bash
# Logs da Lambda
aws logs tail /aws/lambda/lambda-container-api-dev --follow

# Logs do API Gateway
aws logs tail /aws/apigateway/lambda-container-api-dev-api --follow

# M√©tricas CloudWatch
aws cloudwatch get-metric-statistics \
  --namespace AWS/Lambda \
  --metric-name Invocations \
  --dimensions Name=FunctionName,Value=lambda-container-api-dev \
  --start-time 2025-08-07T00:00:00Z \
  --end-time 2025-08-07T23:59:59Z \
  --period 3600 \
  --statistics Sum
```

## üéØ Considera√ß√µes do Teste

### O que foi implementado com sucesso:

‚úÖ **API funcional**: Flask com rotas `/hello` e `/echo` exatamente como especificado  
‚úÖ **Container Docker**: Otimizado para AWS Lambda  
‚úÖ **ECR Integration**: Build e push automatizado  
‚úÖ **Terraform IaC**: Infraestrutura completa como c√≥digo  
‚úÖ **Backend S3**: Estado remoto com lock DynamoDB  
‚úÖ **API Gateway**: HTTP API integrado √† Lambda  
‚úÖ **Outputs**: URL da API e nome da fun√ß√£o  
‚úÖ **CI/CD**: Pipeline completo com GitHub Actions  
‚úÖ **Monitoramento**: CloudWatch, X-Ray, alertas  
‚úÖ **Seguran√ßa**: IAM roles, scanning, encryption  
‚úÖ **Documenta√ß√£o**: README completo com instru√ß√µes  

### Extras implementados:

üöÄ **Health Check**: Endpoint adicional para monitoramento  
üöÄ **Structured Logging**: Logs em JSON para melhor observabilidade  
üöÄ **Performance Optimization**: Cold start otimizado  
üöÄ **Security Scanning**: Vulnerabilidades em c√≥digo e containers  
üöÄ **Test Coverage**: Suite completa de testes  
üöÄ **Pre-commit Hooks**: Qualidade de c√≥digo automatizada  
üöÄ **Multi-environment**: Configura√ß√£o para dev/staging/prod  

### Desafios enfrentados e solu√ß√µes:

1. **Lambda Container Runtime**: Inicialmente havia erro com `AWS_LAMBDA_EXEC_WRAPPER`, resolvido removendo a vari√°vel desnecess√°ria.

2. **API Gateway Integration**: Precisou ajustar o handler Lambda para processar corretamente eventos do API Gateway.

3. **Terraform Backend**: Implementado script automatizado para configurar S3 backend com seguran√ßa.

4. **CI/CD Permissions**: Configurado IAM roles com permiss√µes m√≠nimas necess√°rias.

## üìû Suporte

- **Issues**: Para bugs e problemas
- **Discussions**: Para perguntas e sugest√µes
- **Documentation**: Arquivos em `docs/` para detalhes t√©cnicos

---

**Desenvolvido com ‚ù§Ô∏è para o teste t√©cnico AWS + Terraform**

‚≠ê **Resultado**: API funcionando em produ√ß√£o com infraestrutura automatizada!
